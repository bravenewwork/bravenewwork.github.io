/**
 * audiowalk
 * @version v0.1.0 - 2014-06-19
 * @link https://github.com/lennart/audiowalk
 * @author Lennart Melzer ()
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
"use strict";var app=angular.module("lennart.Audiowalk",["ngAnimate","ngRoute","mediaPlayer","ngTouch","slick","duScroll","ngSanitize","angularSpinner","FBAngular","google-maps","ui.bootstrap","fitVids","angular-loading-bar"]);app.constant("version","v0.1.0").config(["$locationProvider","$routeProvider",function(e,n){e.html5Mode(!0),n.when("/kaffee-kochen",{templateUrl:"views/kaffee-kochen.html"}).when("/:slide?",{templateUrl:"views/home.html",reloadOnSearch:!1}).when("/contact",{templateUrl:"views/contact.html"}).otherwise({redirectTo:"/"})}]).run(["$rootScope","$location","$log",function(e,n,o){e.$on("duScrollspy:becameActive",function(t,i){o.debug("scroll spy active",i.data("slideId"));var r=i.data("slideId");r&&(n.search({slide:r}).replace(),e.$apply(),e.$on("slide:changed",r))})}]),app.controller("MainCtrl",["$scope","$location","version","$log","VideoPlayer","$window","Fullscreen","StoryBoard",function(e,n,o,t,i,r,a,l){function s(e){return u[e]}function d(n,o){u[o]=p.length,e.audioPlaylist.push({src:n})}e.$path=n.path.bind(n),e.version=o;var c=l();i.get().then(function(e){t.info("got player",e)}).catch(function(e){t.error("error in video player",e)}),a.all(),t.info("Standalone",r.navigator.standalone);var u={},p=e.audioPlaylist=[];e.resolvePlaylistIndex=s,angular.forEach(c,function(e,n){e.audio&&d(e.audio,n)})}]),app.controller("PlacesCtrl",["$rootScope","$scope","$sce","$routeParams","StoryBoard","$log","$window","$element","$location","$timeout","Geolocation","$document",function(e,n,o,t,i,r,a,l,s,d,c,u){function p(e,n){var o=e.filter(function(e){return e.id==n});return o[0]?e.indexOf(o[0]):0}function f(e,n){var o;return(o=e[n])?o.id:null}var g=n.slides=i(),h={linear:function(e){return e},easeInQuad:function(e){return e*e},easeOutQuad:function(e){return e*(2-e)},easeInOutQuad:function(e){return.5>e?2*e*e:-1+(4-2*e)*e},easeInCubic:function(e){return e*e*e},easeOutCubic:function(e){return--e*e*e+1},easeInOutCubic:function(e){return.5>e?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1},easeInQuart:function(e){return e*e*e*e},easeOutQuart:function(e){return 1- --e*e*e*e},easeInOutQuart:function(e){return.5>e?8*e*e*e*e:1-8*--e*e*e*e},easeInQuint:function(e){return e*e*e*e*e},easeOutQuint:function(e){return 1+--e*e*e*e*e},easeInOutQuint:function(e){return.5>e?16*e*e*e*e*e:1+16*--e*e*e*e*e}},m={},v=300,y="ease-in";m.onBeforeChange=function(){r.info("onBeforeChange",arguments),n.lastSlide=n.currentSlide,e.$emit("audio:stop:"+n.currentSlide)},m.onAfterChange=function(){d(function(){r.info("slide changed",n.currentSlide,o,"last slide",n.lastSlide);var o=f(n.slides,n.currentSlide);o&&e.$emit("audio:play:"+n.currentSlide)},v)},n.$on("scroll:next",function(e,o){r.info("[places] scroll:next ",o);var t=p(g,o),i=g[t+1];i?(r.debug("[places] going to next slide",i.id),n.$apply(s.path(i.id))):r.debug("[places] there's no way further from",g[t])}),n.$on("scroll:prev",function(e,o){r.info("[places] scroll:prev ",o);var t=p(g,o),i=g[t-1];i?(r.debug("[places] going to prev slide",i.id),n.$apply(s.path(i.id))):r.debug("[places] there's no way back from",g[t])}),n.$on("scroll:show",function(e,n){r.info("[places] scroll:show ",n)}),m.speed=v,m.cssEase=y,n.currentSlide=p(n.slides,t.slide),n.carousel=m,n.currentPosition={};var $;u.on("scroll",function(){$&&d.cancel($),$=d(function(){for(var e,o=l.find(".slide-marker"),t=window.scrollY,i=0;!e&&t>0&&i<o.length;){var a=o[i].offsetTop;if(a>=t){e=u.find("#slide-scroll-top-"+i);var s=e.data("slideId"),c=p(g,s);r.info("decayed scrolling to",e,i,"next up",s,c),u.scrollTo(e,0,350,h.easeInCubic),d(function(){m.onBeforeChange(),r.info("scrolled to",c,"from",n.currentSlide),n.currentSlide=c,m.onAfterChange()},350)}i++}e=null},250)}),n.slide=g[n.currentSlide],e.$on("$routeUpdate",function(){})}]),app.controller("PlaceCtrl",["$scope","$log","$element","$document",function(e,n,o,t){var i=o;n.info("media content links",i[0],o),e.slide.url||(n.info("registering click handler for scrolling",e.slide.id),i.click(function(e){n.info("smooth scroll");var i="#"+this.href.split("#").pop(),r=o.parents(),a=r.find(i);t.scrollToElement(a,10,500),e.preventDefault()}))}]),app.controller("VideoCtrl",["$element","$log","$document",function(){}]),app.controller("MapCtrl",["$log","$element","$scope","$location","Geolocation",function(e,n,o,t,i){o.map={center:{latitude:52.529781,longitude:13.401393},options:{fit:!0,streetViewControl:!1,maxZoom:40,minZoom:12},zoom:17,currentPosition:{},showKml:!0,currentMarkerOptions:{animation:google.maps.Animation.BOUNCE}},i.current().then(function(n){e.info("current position",n),o.map.currentPosition={longitude:n.coords.longitude,latitude:n.coords.latitude}}).catch(function(n){e.error("Failed to read current Position",n)}),o.kmlUrl=t.protocol()+"://"+t.host()+"/data/01-ausland.kml",e.info("kmlUrl",o.kmlUrl),o.kmlLayerOptions={url:o.kmlUrl}}]),app.controller("SlidesCtrl",["$scope",function(){}]),app.controller("UndergroundCtrl",["$log","$window","$document","$timeout","usSpinnerService",function(e,n,o,t,i){e.info("[underground] online"),i.start("spinner-1"),t(function(){i.stop("spinner-1")},5e3)}]),app.service("Geolocation",["$rootScope","$window","$q",function(e,n,o){var t=this;this.supportGeolocation=!!n.navigator,this.current=function(){var i=o.defer();return t.supportGeolocation?n.navigator.geolocation.getCurrentPosition(function(n){e.$apply(function(){i.resolve(n)},function(e){i.reject(e)})}):i.reject({message:"Device does not support Geolocation"}),i.promise}}]),app.service("VideoPlayer",["$window","$log","$q",function(e,n,o){this.get=function(){var t=o.defer();return e.YT?t.resolve(YT.Player):e.onYouTubeIframeAPIReady=function(){n.info("YouTube Player API Ready",YT.Player),t.resolve(YT.Player)},t.promise}}]),app.value("StoryBoard",function(){return[{id:"start",title:"BRAVE<br>NEW<br>WORK"},{id:"kaffee-kochen-quote",caption:"Kaffee kochen",scrollDown:!0,video:"PFVcfyqm9_Y",videoStill:"kaffee-kochen.jpg",theme:{},effects:{out:"slideInRight","in":""}},{id:"st-oberholz",caption:"St. Oberholz",audio:"/audio/01-stoberholz.mp3"},{id:"ausland",caption:"Weg zum Haus aus einem anderen Land",maps:"https://www.google.com/maps/embed?pb=!1m29!1m12!1m3!1d1213.5841912603892!2d13.40105350178898!3d52.530387583271406!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!4m14!1i0!3e2!4m5!1s0x47a851e51ffe4c8f%3A0x81d84dd51899d817!2sBrunnenstra%C3%9Fe+11%2C+10119+Berlin%2C+Germany!3m2!1d52.5313641!2d13.400299799999999!4m5!1s0x47a851e4644a4b75%3A0xf49417256487121c!2sGastst%C3%A4tte+St.+Oberholz%2C+Rosenthaler+Stra%C3%9Fe+72a%2C+10119+Berlin%2C+Germany!3m2!1d52.529512!2d13.401764!5e0!3m2!1sen!2s!4v1402598598218",audio:"/audio/02-jura.mp3",autoplay:!0},{id:"tips-please",caption:"Spenden",image:"/images/tip-jar.jpg"}]}),app.controller("AudioCtrl",["$rootScope","$log","$scope","$element",function(e,n,o,t){var i=this;o.playing=0;var r=t.find("button"),a=o.audioPlayer;o.audioCanplay=!1,e.$on("audio:play:"+o.$index,function(){o.slide.autoplay&&(o.playing=!0)}),e.$on("audio:stop:"+o.$index,function(){o.playing=!1}),this.play=function(){if(r.addClass("playing"),!a.playing)if(n.info("network",a.network),void 0===a.network)a.one("suspend",function(){i.play()});else{var e=o.resolvePlaylistIndex(o.$index);n.info("playing",e),a.playPause(e,!0)}},this.pause=function(){r.removeClass("playing"),a.playing&&a.playPause(o.resolvePlaylistIndex(o.$index),!0)},o.$watch("playing",function(e){e?i.play():i.pause()})}]),app.directive("bnwScroll",["$log","$swipe","$window","$document",function(e,n,o){return{restrict:"E",scope:{slideId:"="},controller:function(){e.info("[scroll] init")},link:function(n){var t,i=.15,r=o.outerHeight;n.dragStart=null,n.percentage=0,n.touchStart=function(e){null===n.dragStart&&(n.dragStart=e.clientY)},n.touchMove=function(o){null!==n.dragStart&&(t=n.dragStart-o.clientY,n.percentage=t/r,e.debug("percent dragged",n.percentage))},n.touchEnd=function(){n.dragStart=null,n.percentage>=i?n.$emit("scroll:next",n.slideId):Math.abs(n.percentage)>=i?n.$emit("scroll:prev",n.slideId):n.$emit("scroll:show",n.slideId),n.percentage=0}}}}]),app.directive("bnwVideoPlayer",["$log","VideoPlayer","$timeout",function(e,n,o){return{restrict:"E",link:function(t,i){var r="video-player-"+t.index;i.find(".video-player").attr("id",r);var a=i.find(".btn-video-play"),l=i.find(".spinner"),s=i.find(".glyphicon-facetime-video");t.videoLoaded=!1,t.playing=!1;var d=i.find(".video-wrapper"),c=i.find("video")[0];a.click(function(){t.loading=!0,t.playing=!0,l.removeClass("hide"),s.addClass("hide"),o(function(){n.get().then(t.loadVideo).catch(function(n){e.error("error on player get",n)})},3e3)}),t.loadVideo=function(n){e.info("player on click",n,r),t.videoLoaded,t.onVideoReady()},c.addEventListener("playing",function(){d.removeClass("hide"),a.addClass("hide")}),c.addEventListener("pause",function(){a.removeClass("hide"),d.addClass("hide"),s.removeClass("hide")}),t.onVideoReady=function(){t.videoLoaded=!0,c.play(),t.playing=!0,t.loading=!1,l.addClass("hide")},t.onStateChange=function(n){switch(e.info("state change",n),n.data){case YT.PlayerState.PLAYING:case YT.PlayerState.BUFFERING:d.removeClass("hide"),a.addClass("hide");break;case YT.PlayerState.ENDED:case YT.PlayerState.PAUSED:a.removeClass("hide"),d.addClass("hide")}},t.stopVideo=function(){player.pause(),t.playing=!1}}}}]),app.directive("bnwSlick",["$timeout",function(e){return{restrict:"AEC",scope:{currentIndex:"=",accessibility:"@",arrows:"@",autoplay:"@",autoplaySpeed:"@",centerMode:"@",centerPadding:"@",cssEase:"@",dots:"@",draggable:"@",easing:"@",fade:"@",infinite:"@",lazyLoad:"@",onBeforeChange:"&",onAfterChange:"&",onInit:"@",onReInit:"@",pauseOnHover:"@",responsive:"&",slide:"@",slidesToShow:"@",slidesToScroll:"@",speed:"@",swipe:"@",touchMove:"@",touchThreshold:"@",vertical:"@"},link:function(n,o){return e(function(){var e,t;return t=$(o),null!=n.currentIndex&&(e=n.currentIndex),t.slick({accessibility:"false"!==n.accessibility,arrows:"false"!==n.arrows,autoplay:"true"===n.autoplay,autoplaySpeed:null!=n.autoplaySpeed?parseInt(n.autoplaySpeed,10):3e3,centerMode:"true"===n.centerMode,centerPadding:n.centerPadding||"50px",cssEase:n.cssEase||"ease",dots:"true"===n.dots,draggable:"false"!==n.draggable,easing:n.easing||"linear",fade:"true"===n.fade,infinite:"false"!==n.infinite,lazyLoad:n.lazyLoad||"ondemand",onBeforeChange:n.onBeforeChange||null,onAfterChange:function(o,t){return n.onAfterChange&&n.onAfterChange(),null!=e?n.$apply(function(){return e=t,n.currentIndex=t}):void 0},onInit:function(o){return n.onInit&&n.onInit(),null!=e?o.slideHandler(e):void 0},onReInit:n.onReInit||null,pauseOnHover:"false"!==n.pauseOnHover,responsive:n.responsive()||null,slide:n.slide||"div",slidesToShow:null!=n.slidesToShow?parseInt(n.slidesToShow,10):1,slidesToScroll:null!=n.slidesToScroll?parseInt(n.slidesToScroll,10):1,speed:null!=n.speed?parseInt(n.speed,10):300,swipe:"false"!==n.swipe,touchMove:"false"!==n.touchMove,touchThreshold:n.touchThreshold?parseInt(n.touchThreshold,10):5,vertical:"true"===n.vertical}),n.$watch("currentIndex",function(n){return null!=e&&null!=n&&n!==e?t.slickGoTo(n):void 0})})}}}]),app.directive("mediaLink",["$log","$document","$filter",function(){return{restrict:"E",scope:{url:"=",index:"="},transclude:!0,controller:["$scope",function(){}],link:function(e,n){var o,t=n.find("a.media-content-link");o=e.url?e.url:"#media-content-"+e.index,t.attr("href",o)},templateUrl:"views/media-link.html"}}]);