/**
 * audiowalk
 * @version v0.1.0 - 2014-06-25
 * @link https://github.com/lennart/audiowalk
 * @author Lennart Melzer ()
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
"use strict";function getDistance(e,a,n,i){var o=6371,t=(n-e).toRad(),r=(i-a).toRad(),s=Math.sin(t/2)*Math.sin(t/2)+Math.cos(e.toRad())*Math.cos(n.toRad())*Math.sin(r/2)*Math.sin(r/2),l=2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s));return o*l}var app=angular.module("lennart.Audiowalk",["ngAnimate","ngRoute","LocalStorageModule","mediaPlayer","ngTouch","ngSanitize","angularSpinner","duScroll","FBAngular","google-maps","fitVids","angular-loading-bar"]);app.constant("version","v0.1.0").config(["$locationProvider","$routeProvider",function(e,a){a.when("/",{templateUrl:"views/start.html"}).when("/credits",{templateUrl:"views/credits.html"}).when("/:slide?",{templateUrl:"views/slide.html"}).otherwise({redirectTo:"/"})}]).run(["$rootScope","$location","$log","localStorageService",function(){}]),app.controller("MainCtrl",["$scope","$location","version","$log","$window","Fullscreen","Places","$routeParams","$rootScope","localStorageService","Audio","Geolocation",function(e,a,n,i,o,t,r,s,l,d,c,u){t.all(),i.info("Standalone",o.navigator.standalone),e.updateCurrentSlide=function(a){i.info("updating current slide",a),e.currentSlide=r.idToSlideIndex(a),i.info("currentSlide:",e.currentSlide),e.slide=r.slides[e.currentSlide],e.$index=e.currentSlide},l.$on("$routeChangeSuccess",function(a,n,o){o&&(i.info("Stopping Audio",e.$index),l.$emit("audio:stop:"+e.$index)),e.updateCurrentSlide(n.params.slide),r.slides.length-1===e.currentSlide?d.set("finished","yes"):i.info("[main] yet another slide")}),l.$on("$routeChangeStart",function(){u.unwatch()})}]),app.controller("StartCtrl",["$scope","$location","version","$log","$window","Fullscreen","Places","$routeParams","$rootScope","localStorageService","$document","$element",function(e,a,n,i,o,t,r,s,l,d,c,u){e.$path=a.path.bind(a),e.version=n,e.loadProgress={loaded:0,total:0,ready:!1,percentage:0},e.firstSlide=r.slides[0].id;var p=function(a){console.log("appcacheevent: ",a,e.loadProgress),"checking"==a.type?e.loadProgress.ready=!1:"downloading"==a.type?e.loadProgress.ready=!1:"error"==a.type?(e.loadProgress.ready=!0,e.$apply()):"noupdate"==a.type?(e.loadProgress.percentage="100%",e.loadProgress.ready=!0,e.$apply()):"progress"==a.type?(e.loadProgress.percentage=a.loaded/a.total*100+"%",e.loadProgress.total=a.total,e.loadProgress.loaded=a.loaded,e.$apply()):"cached"==a.type?(e.loadProgress.percentage="100%",e.loadProgress.ready=!0,e.$apply(),e.$apply()):"updateready"==a.type&&(e.loadProgress.percentage="100%",e.loadProgress.ready=!0,e.$apply())};if(o.applicationCache){var g=o.applicationCache;g.addEventListener("error",p,!1),g.addEventListener("checking",p,!1),g.addEventListener("noupdate",p,!1),g.addEventListener("downloading",p,!1),g.addEventListener("progress",p,!1),g.addEventListener("updateready",p,!1),g.addEventListener("cached",p,!1)}e.credits=!1,e.toggleCredits=function(){e.credits=e.credits===!1?!0:!1,e.credits===!0&&c.scrollToElement(u.find("#credits-block"),0,1500,function(e){return.5>e?2*e*e:-1+(4-2*e)*e})},l.currentSound&&l.currentSound.stop(),"yes"==d.get("finished")?(d.set("finished","no"),i.info("[start] finished",d.get("finished")),e.toggleCredits(),e.loadProgress.ready=!0):i.info("[start] go!")}]),app.controller("PlacesCtrl",["$rootScope","$scope","$sce","$routeParams","Places","$log","$window","$element","$location","$timeout","Geolocation","$document","Audio",function(e,a,n,i,o,t,r,s,l,d,c,u,p){a.nextSlideId=o.indexToSlideId(a.currentSlide+1),a.nextSlide=o.slides[a.currentSlide+1],a.prevSlideId=o.indexToSlideId(a.currentSlide-1);var g=o.slides[a.currentSlide];if(e.currentSlideId=g.id,p.pauseAll(),g.audio){var m=p.audios[g.id];m.bind("ended",function(){g.maps?t.info("dont go to next slide because the current slide is a map"):(l.path(a.nextSlide.id).replace(),e.$apply())}),m.play()}a.$on("map:destination:reached",function(){l.path(a.nextSlide.id).replace()}),a.playAudio=function(){},a.playing=p.playing,a.toggleAudio=function(){if(g.audio){var e=p.audios[g.id];t.info("current audio",e),a.playing(g.id)?e.pause():e.play()}}}]),app.controller("MapCtrl",["$log","$element","$scope","$location","$rootScope","$q","Geolocation",function(e,a,n,i,o,t,r){console.log("map"),n.watchUserPosition=function(){e.info("[map] watching movements"),o.$on("geolocation:changed",function(e,a){console.log("location",a)}),o.$on("geolocation:error",function(a,n){e.error("Failed watching position",n)}),r.watch()},n.watchUserPosition()}]),app.service("Geolocation",["$rootScope","$window","$q","$log",function(e,a,n,i){function o(e){return e*(Math.PI/180)}var t=this,r=null;this.supportGeolocation=!!a.navigator,this.current=function(){var i=n.defer();return t.supportGeolocation?a.navigator.geolocation.getCurrentPosition(function(a){e.$apply(function(){i.resolve(a)})},function(e){i.reject(e)},{enableHighAccuracy:!0}):i.reject({message:"Device does not support Geolocation"}),i.promise},this.watch=function(){t.supportGeolocation?r=a.navigator.geolocation.watchPosition(function(a){e.$emit("geolocation:changed",a)},function(a){e.$emit("geolocation:error",a)},{enableHighAccuracy:!0}):e.$emit("geolocation:error","device does not support geolocation")},this.unwatch=function(){r&&(i.info("[geo] do not movements anymore"),a.navigator.geolocation.clearWatch(r))},this.distanceInKm=function(e,a,n,i){var t=6371,r=o(n-e),s=o(i-a),l=Math.sin(r/2)*Math.sin(r/2)+Math.cos(o(e))*Math.cos(o(n))*Math.sin(s/2)*Math.sin(s/2),d=2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l)),c=t*d;return c}}]),app.value("StoryBoard",function(){return[{id:"weg-zum-st-oberholz",caption:"Weg zum St. Oberholz",maps:{destination:"Rosenthaler Straße 72a, Berlin, Germany"}},{id:"st-oberholz",caption:"St. Oberholz",audio:"/audio/1.mp3",image:"/images/places/stoberholz.jpg"},{id:"ausland",caption:"Weg zum Haus aus einem anderen Land",maps:{destination:"52.529781,13.401393",waypoints:[{location:"Rosenthaler Straße 72a, Berlin, Germany"}]},audio:"/audio/A.mp3",autoplay:!0},{id:"haus-aus-einem-anderen-land",caption:"Haus aus einem anderen Land",audio:"/audio/2.mp3",image:"/images/places/haus_aus_einem_anderen_land.jpg"},{id:"weg-zum-leihamt",caption:"Weg zum Königlichen Leihamt",maps:{destination:"Linienstraße 98, Berlin, Germany",waypoints:[{location:"Brunnenstraße 10, Berlin, Germany"}],kml:"/data/leihamt.kml",zoom:16},audio:"/audio/B.mp3",autoplay:!0},{id:"leihamt",caption:"Königliches Leihamt",audio:"/audio/3.mp3",image:"/images/places/leihamt.jpg"},{id:"weg-zum-leerstehenden-haus",caption:"Weg zum Leerstehenden Haus",maps:{destination:"Linienstraße 86, Berlin, Germany",waypoints:[{location:"Linienstraße 98, Berlin, Germany"}]},audio:"/audio/C.mp3",autoplay:!0},{id:"leerstehendes-haus",caption:"Leerstehendes Haus",audio:"/audio/4.mp3",image:"/images/places/leerstehendes_haus.jpg"},{id:"weg-zum-besetzten-haus",caption:"Weg zum besetzten Haus",maps:{destination:"Linienstraße 206, Berlin, Germany",waypoints:[{location:"Linienstraße 86, Berlin, Germany"}]},audio:"/audio/D.mp3"},{id:"besetztes-haus",caption:"Besetztes Haus",audio:"/audio/5.mp3",image:"/images/places/besetztes_haus.jpg"},{id:"weg-zum-garnisonsfriedhof",caption:"Weg zum Garnisonsfriedhof",maps:{destination:"Garnisonsfriedhof, Kleine Rosenthaler Straße, Berlin, Germany",waypoints:[{location:"Linienstraße 206, Berlin, Germany"}]},audio:"/audio/E.mp3"},{id:"garnisonsfriedhof",caption:"Garnisonsfriedhof",audio:"/audio/6.mp3",image:"/images/places/garnisonsfriedhof.jpg"},{id:"weg-zum-centralen-arbeitsnachweis",caption:"Weg zum Centralen Arbeitsnachweis",maps:{destination:"Gormannstraße 13, Berlin, Germany",waypoints:[{location:"Garnisonsfriedhof, Kleine Rosenthaler Straße, Berlin, Germany"}]}},{id:"centraler-arbeitsnachweis",caption:"Centraler Arbeitsnachweis",audio:"/audio/arbeitsnachweis.mp3",image:"/images/places/arbeitsnachweis.jpg"},{id:"weg-zum-wunschgarten",caption:"Weg zum Wunschgarten",maps:{destination:"Mulackstraße 8-11, Berlin, Germany",waypoints:[{location:"Gormannstraße 13, Berlin, Germany"}]}},{id:"wunschgarten",caption:"Wunschgarten",audio:"/audio/wunschgarten_flitterzaun.mp3",image:"/images/places/wunschgarten.jpg"},{id:"weg-zur-volksbuehne",caption:"Weg zur Volksbühne",maps:{destination:"52.527049,13.411903",waypoints:[{location:"Mulackstraße 38-41, Berlin, Germany"}]}},{id:"volksbuehne",caption:"Volksbühne AM Rosa-Luxemburg-Platz",audio:"/audio/volksbuehne.mp3",image:"/images/places/volksbuehne.jpg"},{id:"weg-zum-arbeiterdenkmal",caption:"Weg zum Arbeiterdenkmal",maps:{destination:"52.525248,13.413445",waypoints:[{location:"52.527049,13.411903"}]}},{id:"arbeiterdenkmal",caption:"Arbeiterdenkmal",audio:"/audio/arbeiterdenkmal.mp3",image:"/images/places/arbeiterdenkmal.jpg"},{id:"weg-zum-karl-liebknecht-haus",caption:"Weg zum Karl-Liebknecht-Haus",maps:{destination:"Kleine Alexanderstraße 28, Berlin, Germany",waypoints:[{location:"52.525248,13.413445"}]}},{id:"karl-liebknecht-haus",caption:"Karl-Liebknecht-Haus",audio:"/audio/karl-liebknecht-haus.mp3",image:"/images/places/karl-liebknecht-haus.jpg"},{id:"weg-zum-soho-haus",caption:"Weg zum Soho House",maps:{destination:"Torstraße 1, Berlin, Germany",waypoints:[{location:"Kleine Alexanderstraße 28, Berlin, Germany"}]}},{id:"soho-House",caption:"Soho House",audio:"/audio/soho-house.mp3",image:"/images/places/soho.jpg"}]}),app.factory("Places",["StoryBoard","$log",function(e){var a=e();return{idToSlideIndex:function(e){var n=a.filter(function(a){return a.id==e});return n[0]?a.indexOf(n[0]):0},indexToSlideId:function(e){var n;return(n=a[e])?n.id:null},slides:a}}]),app.service("Audio",["$q","$log","Places","$rootScope","$timeout",function(e,a,n,i,o){var t=this,r=this.audios={};angular.forEach(n.slides,function(e){e.audio&&(r[e.id]=new buzz.sound(e.audio))}),this.delayedStartStop=function(e,a){a=a||100;var n=r[e];n.play();var i=function(){n.pause()};return o(i,a,!0)},this.ensureAutoplay=function(){var a=(e.defer(),n.slides.filter(function(e){return!!e.audio}).map(function(e){return t.delayedStartStop(e.id,100)}));return e.all(a)},this.pauseAll=function(){angular.forEach(r,function(e){e.pause()})},this.playing=function(e){var a=r[e];return a?!a.isPaused():!1}}]),app.directive("bnwModal",["$log",function(){return{restrict:"E",scope:{show:"="},replace:!0,transclude:!0,link:function(e){e.accept=function(){e.$emit("modal:accepted")}},templateUrl:"views/partials/modal.html"}}]);