/**
 * audiowalk
 * @version v0.1.0 - 2014-06-28
 * @link https://github.com/lennart/audiowalk
 * @author Lennart Melzer ()
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
"use strict";var app=angular.module("lennart.Audiowalk",["ngAnimate","ngRoute","LocalStorageModule","mediaPlayer","ngTouch","ngSanitize","angularSpinner","duScroll","FBAngular","google-maps","fitVids"]);app.constant("version","v0.1.0").config(["$locationProvider","$routeProvider",function(e,i){i.when("/",{templateUrl:"views/start.html"}).when("/credits",{templateUrl:"views/credits.html"}).when("/:slide?",{templateUrl:"views/slide.html"}).otherwise({redirectTo:"/"})}]).run(["$rootScope","$location","$log","localStorageService",function(){}]),app.controller("MainCtrl",["$scope","$location","version","$log","$window","Fullscreen","Places","$routeParams","$rootScope","localStorageService","Audio","Geolocation",function(e,i,a,n,t,o,s,d,r,l,u,c){o.all(),n.info("Standalone",t.navigator.standalone),e.updateCurrentSlide=function(i){n.info("updating current slide",i),e.currentSlide=s.idToSlideIndex(i),e.slide=s.slides[e.currentSlide],e.$index=e.currentSlide,e.nextSlideId=s.indexToSlideId(e.currentSlide+1),e.nextSlide=s.slides[e.currentSlide+1],e.prevSlideId=s.indexToSlideId(e.currentSlide-1),r.currentSlideId=e.slide.id,n.info("[main] slide change",{current:e.slide.id,next:e.nextSlideId,prev:e.prevSlideId})},r.$on("$routeChangeSuccess",function(i,a){e.updateCurrentSlide(a.params.slide),s.slides.length-1===e.currentSlide?l.set("finished","yes"):n.info("[main] yet another slide")}),r.$on("$routeChangeStart",function(){c.unwatch()}),e.changeSlide=function(e){i.path(e).replace(),r.$apply()}}]),app.controller("StartCtrl",["$scope","$location","version","$log","$window","Fullscreen","Places","$routeParams","$rootScope","localStorageService","$document","$element",function(e,i,a,n,t,o,s,d,r,l,u,c){e.$path=i.path.bind(i),e.version=a,e.loadProgress={loaded:0,total:0,ready:!1,percentage:0},e.firstSlide=s.slides[0].id;var p=function(i){console.log("appcacheevent: ",i,e.loadProgress),"checking"==i.type?e.loadProgress.ready=!1:"downloading"==i.type?e.loadProgress.ready=!1:"error"==i.type?(e.loadProgress.ready=!0,e.$apply()):"noupdate"==i.type?(e.loadProgress.percentage="100%",e.loadProgress.ready=!0,e.$apply()):"progress"==i.type?(e.loadProgress.percentage=i.loaded/i.total*100+"%",e.loadProgress.total=i.total,e.loadProgress.loaded=i.loaded,e.$apply()):"cached"==i.type?(e.loadProgress.percentage="100%",e.loadProgress.ready=!0,e.$apply(),e.$apply()):"updateready"==i.type&&(e.loadProgress.percentage="100%",e.loadProgress.ready=!0,e.$apply())};if(t.applicationCache){var g=t.applicationCache;g.addEventListener("error",p,!1),g.addEventListener("checking",p,!1),g.addEventListener("noupdate",p,!1),g.addEventListener("downloading",p,!1),g.addEventListener("progress",p,!1),g.addEventListener("updateready",p,!1),g.addEventListener("cached",p,!1)}e.credits=!1,e.toggleCredits=function(){e.credits=e.credits===!1?!0:!1,e.credits===!0&&u.scrollToElement(c.find("#credits-block"),500,15e3,function(e){return.5>e?2*e*e:-1+(4-2*e)*e})},o.all(),r.currentSound&&r.currentSound.stop(),"yes"==l.get("finished")?(l.set("finished","no"),n.info("[start] finished",l.get("finished")),e.toggleCredits(),e.loadProgress.ready=!0):n.info("[start] go!")}]),app.controller("PlacesCtrl",["$rootScope","$scope","$sce","$routeParams","Places","$log","$window","$element","$location","$timeout","Geolocation","$document","Audio",function(e,i,a,n,t,o,s,d,r,l,u,c,p){if(i.$on("map:destination:reached",function(){o.info("[places] destination reached, vibrating, awareness, now!"),navigator.vibrate&&navigator.vibrate(1e3),i.notice="Ziel erreicht!",i.showNotice=!0,l(function(){o.info("[places] hide destination notice"),i.showNotice=!1},5e3),i.$emit("slide:change:request")}),i.$on("slide:change:request",function(){o.info("[places] wants to change slide"),i.destinationReached&&i.soundEnded?(i.changeSlide(i.nextSlide?i.nextSlide.id:""),i.resetAutoChange()):o.info(i.destinationReached?"but first lets hear that sound till the end!":"but first we have to get to the destination!")}),i.$on("change:distance",function(e,a){o.info("[places] changed distance",arguments),l(function(){i.slide.distance=a},500)}),i.resetAutoChange=function(){i.destinationReached=!1,i.soundEnded=!1},i.toggleAudio=function(){if(i.slide.audio){var e=p.audios[i.slide.id];o.info("current audio",e),i.playing(i.slide.id)?e.pause():e.play()}},i.jumpToEndOfAudio=function(){if(i.slide.audio){var e=p.audios[i.slide.id];e.isPaused()||e.setPercent(98)}},i.watchUserPosition=function(){o.info("[map] watching movements"),e.$on("geolocation:changed",function(e,a){if(i.destinationReached)o.info("[places] geolocation already reached, cease distance calc");else{{t.slides[i.currentSlide]}if(i.slide.maps&&i.slide.maps.destination&&i.slide.maps.destination.latitude&&i.slide.maps.destination.longitude){o.info(a.coords.latitude,a.coords.longitude,i.slide.maps.destination.latitude,i.slide.maps.destination.longitude);var n=u.distanceInKm(a.coords.latitude,a.coords.longitude,i.slide.maps.destination.latitude,i.slide.maps.destination.longitude);o.info("distance",n),i.slide.destination_distance=Math.round(1e3*n*100)/100,i.$emit("change:distance",i.slide.destination_distance),.015>n?(o.info("reached!",i.currentSlideId,i.nextSlide.id),i.destinationReached=!0,u.unwatch(),i.$emit("map:destination:reached")):o.info("the waypoint is ",n,"away!")}else o.info("no destination")}}),e.$on("geolocation:error",function(e,i){o.error("Failed watching position",i)}),u.watch()},i.playing=p.playing,i.showNotice=!1,p.pauseAll(),u.unwatch(),i.slide.maps?(i.watchUserPosition(),u.current().then(function(i){o.info("current position",i),e.$emit("geolocation:changed",i)}).catch(function(e){o.error("Failed to read current Position",e)})):(i.destinationReached=!0,u.unwatch()),i.slide.audio){var g=p.audios[i.slide.id];g.bindOnce("ended",function(){i.soundEnded=!0,i.$emit("slide:change:request")}),g.play()}else i.soundEnded=!0}]),app.service("Geolocation",["$rootScope","$window","$q","$log",function(e,i,a,n){function t(e){return e*(Math.PI/180)}var o=this,s=null;this.supportGeolocation=!!i.navigator,this.current=function(){var e=a.defer();return o.supportGeolocation?i.navigator.geolocation.getCurrentPosition(function(i){e.resolve(i)},function(i){e.reject(i)},{enableHighAccuracy:!0}):e.reject({message:"Device does not support Geolocation"}),e.promise},this.watch=function(){o.supportGeolocation?s=i.navigator.geolocation.watchPosition(function(i){e.$emit("geolocation:changed",i)},function(i){e.$emit("geolocation:error",i)},{enableHighAccuracy:!0}):e.$emit("geolocation:error","device does not support geolocation")},this.unwatch=function(){s&&(n.info("[geo] do not care about movements anymore"),i.navigator.geolocation.clearWatch(s))},this.distanceInKm=function(e,i,a,n){var o=6371,s=t(a-e),d=t(n-i),r=Math.sin(s/2)*Math.sin(s/2)+Math.cos(t(e))*Math.cos(t(a))*Math.sin(d/2)*Math.sin(d/2),l=2*Math.atan2(Math.sqrt(r),Math.sqrt(1-r)),u=o*l;return u}}]),app.value("StoryBoard",function(){return[{id:"st-oberholz",caption:"St. Oberholz",audio:"/audio/1.mp3",image:"/images/places/stoberholz.jpg"},{id:"ausland",caption:"Weg zum Haus aus einem anderen Land",maps:{destination:{latitude:52.53109,longitude:13.40011},image:"/images/routes/1.png"},audio:"/audio/way/a.mp3",autoplay:!0},{id:"haus-aus-einem-anderen-land",caption:"Haus aus einem anderen Land",audio:"/audio/2.mp3",image:"/images/places/haus_aus_einem_anderen_land.jpg"},{id:"weg-zum-leihamt",caption:"Weg zum Königlichen Leihamt",maps:{destination:{latitude:52.52857,longitude:13.39634},waypoints:[{location:"Brunnenstraße 10, Berlin, Germany"}],image:"/images/routes/2.png",zoom:16},audio:"/audio/way/b.mp3",autoplay:!0},{id:"leihamt",caption:"Königliches Leihamt",audio:"/audio/3.mp3",image:"/images/places/leihamt.jpg"},{id:"weg-zum-leerstehenden-haus",caption:"Weg zum Leerstehenden Haus",maps:{destination:{latitude:52.52899,longitude:13.3984},image:"/images/routes/3.png",waypoints:[{location:"Linienstraße 98, Berlin, Germany"}]},audio:"/audio/way/c.mp3",autoplay:!0},{id:"leerstehendes-haus",caption:"Leerstehendes Haus",audio:"/audio/4.mp3",image:"/images/places/leerstehendes_haus.jpg"},{id:"weg-zum-besetzten-haus",caption:"Weg zum besetzten Haus",maps:{destination:{latitude:52.52894,longitude:13.40288},image:"/images/routes/4.png",waypoints:[{location:"Linienstraße 86, Berlin, Germany"}]},audio:"/audio/way/d.mp3"},{id:"besetztes-haus",caption:"Besetztes Haus",audio:"/audio/5.mp3",image:"/images/places/besetztes_haus.jpg"},{id:"weg-zum-garnisonsfriedhof",caption:"Weg zum Garnisonsfriedhof",maps:{destination:{latitude:52.52813,longitude:13.4033},image:"/images/routes/5.png",waypoints:[{location:"Linienstraße 206, Berlin, Germany"}]},audio:"/audio/way/e.mp3"},{id:"garnisonsfriedhof",caption:"Garnisonsfriedhof",audio:"/audio/6.mp3",image:"/images/places/garnisonsfriedhof.jpg"},{id:"weg-zum-centralen-arbeitsnachweis",caption:"Weg zum Centralen Arbeitsnachweis",maps:{destination:{latitude:52.52791,longitude:13.40503},image:"/images/routes/6.png",waypoints:[{location:"Garnisonsfriedhof, Kleine Rosenthaler Straße, Berlin, Germany"}]},audio:"/audio/way/f.mp3"},{id:"centraler-arbeitsnachweis",caption:"Centraler Arbeitsnachweis",audio:"/audio/7.mp3",image:"/images/places/arbeitsnachweis.jpg"},{id:"weg-zum-wunschgarten",caption:"Weg zum Wunschgarten",maps:{destination:{latitude:52.52744,longitude:13.40585},image:"/images/routes/7.png",waypoints:[{location:"Gormannstraße 13, Berlin, Germany"}]},audio:"/audio/way/g.mp3"},{id:"wunschgarten",caption:"Wunschgarten",audio:"/audio/8-h-9.mp3",image:"/images/places/wunschgarten.jpg"},{id:"weg-zur-volksbuehne",caption:"Weg zur Volksbühne",maps:{destination:{latitude:52.52593,longitude:13.41102},image:"/images/routes/8.png",waypoints:[{location:"Mulackstraße 38-41, Berlin, Germany"}]},audio:"/audio/way/i.mp3"},{id:"volksbuehne",caption:"Volksbühne AM Rosa-Luxemburg-Platz",audio:"/audio/10.mp3",image:"/images/places/volksbuehne.jpg"},{id:"weg-zum-arbeiterdenkmal",caption:"Weg zum Arbeiterdenkmal",maps:{destination:{latitude:52.52549,longitude:13.41336},image:"/images/routes/9.png",waypoints:[{location:"52.527049,13.411903"}]},audio:"/audio/way/k.mp3"},{id:"arbeiterdenkmal",caption:"Arbeiterdenkmal",image:"/images/places/arbeiterdenkmal.jpg",audio:"/audio/11.mp3"},{id:"weg-zum-karl-liebknecht-haus",caption:"Weg zum Karl-Liebknecht-Haus",maps:{destination:{latitude:52.52658,longitude:13.41294},image:"/images/routes/10.png",waypoints:[{location:"52.525248,13.413445"}]},audio:"/audio/way/l.mp3"},{id:"karl-liebknecht-haus",caption:"Karl-Liebknecht-Haus",audio:"/audio/12.mp3",image:"/images/places/karl-liebknecht-haus.jpg"},{id:"weg-zum-soho-haus",caption:"Weg zum Soho House",maps:{destination:{latitude:52.52689,longitude:13.41518},image:"/images/routes/11.png",waypoints:[{location:"Kleine Alexanderstraße 28, Berlin, Germany"}]},audio:"/audio/way/m.mp3"},{id:"soho-House",caption:"Soho House",audio:"/audio/13.mp3",image:"/images/places/soho.jpg"}]}),app.factory("Places",["StoryBoard","$log",function(e){var i=e();return{idToSlideIndex:function(e){var a=i.filter(function(i){return i.id==e});return a[0]?i.indexOf(a[0]):0},indexToSlideId:function(e){var a;return(a=i[e])?a.id:null},slides:i}}]),app.service("Audio",["$q","$log","Places","$rootScope","$timeout",function(e,i,a,n,t){var o=this,s=this.audios={};angular.forEach(a.slides,function(e){e.audio&&(s[e.id]=new buzz.sound(e.audio))}),this.delayedStartStop=function(e,i){i=i||100;var a=s[e];a.play();var n=function(){a.pause()};return t(n,i,!0)},this.ensureAutoplay=function(){var i=(e.defer(),a.slides.filter(function(e){return!!e.audio}).map(function(e){return o.delayedStartStop(e.id,100)}));return e.all(i)},this.pauseAll=function(){return angular.forEach(s,function(e){e.pause()}),!0},this.playing=function(e){var i=s[e];return i?!i.isPaused():!1}}]),app.directive("bnwModal",["$log",function(){return{restrict:"E",scope:{show:"="},replace:!0,transclude:!0,link:function(e){e.accept=function(){e.$emit("modal:accepted")}},templateUrl:"views/partials/modal.html"}}]);