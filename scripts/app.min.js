/**
 * audiowalk
 * @version v0.1.0 - 2014-06-25
 * @link https://github.com/lennart/audiowalk
 * @author Lennart Melzer ()
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
"use strict";var app=angular.module("lennart.Audiowalk",["ngAnimate","ngRoute","LocalStorageModule","mediaPlayer","ngTouch","ngSanitize","angularSpinner","duScroll","FBAngular","google-maps","fitVids","angular-loading-bar"]);app.constant("version","v0.1.0").config(["$locationProvider","$routeProvider",function(e,n){n.when("/",{templateUrl:"views/start.html"}).when("/credits",{templateUrl:"views/credits.html"}).when("/:slide?",{templateUrl:"views/slide.html"}).otherwise({redirectTo:"/"})}]).run(["$rootScope","$location","$log","localStorageService",function(){}]),app.controller("MainCtrl",["$scope","$location","version","$log","$window","Fullscreen","Places","$routeParams","$rootScope","localStorageService",function(e,n,i,a,o,t,r,s,d,l){t.all(),a.info("Standalone",o.navigator.standalone),e.updateCurrentSlide=function(n){a.info("updating current slide",n),e.currentSlide=r.idToSlideIndex(n),a.info("currentSlide:",e.currentSlide),e.slide=r.slides[e.currentSlide],e.$index=e.currentSlide},d.$on("$routeChangeSuccess",function(n,i,o){o&&(a.info("Stopping Audio",e.$index),d.$emit("audio:stop:"+e.$index)),e.updateCurrentSlide(i.params.slide),r.slides.length-1===e.currentSlide?l.set("finished","yes"):a.info("[main] yet another slide")}),e.playModal={show:!0},e.$on("modal:accepted",function(){a.info("play all audios for short. so we can play them automaticly later"),d.audios={};var n=0;angular.forEach(r.slides,function(e){n+=5,window.setTimeout(function(){e.audio&&(d.audios[e.id]=new buzz.sound(e.audio,{preload:!0}),d.audios[e.id].play(),window.setTimeout(function(){d.audios[e.id].pause()},100))},n)}),e.playModal.show=!1})}]),app.controller("StartCtrl",["$scope","$location","version","$log","$window","Fullscreen","Places","$routeParams","$rootScope","localStorageService","$document","$element",function(e,n,i,a,o,t,r,s,d,l,c,u){e.$path=n.path.bind(n),e.version=i,e.loadProgress={loaded:0,total:0,ready:!0,percentage:0},e.firstSlide=r.slides[0].id;var p=function(n){console.log("appcacheevent: ",n,e.loadProgress),"checking"==n.type?e.loadProgress.ready=!1:"downloading"==n.type?e.loadProgress.ready=!1:"error"==n.type?(e.loadProgress.ready=!0,e.$apply()):"noupdate"==n.type?(e.loadProgress.ready=!0,e.$apply()):"progress"==n.type?(e.loadProgress.percentage=n.loaded/n.total*100+"%",e.loadProgress.total=n.total,e.loadProgress.loaded=n.loaded,e.$apply()):"cached"==n.type?(e.loadProgress.ready=!0,e.$apply()):"updateready"==n.type&&(e.loadProgress.ready=!0,e.$apply())};if(o.applicationCache){var m=o.applicationCache;m.addEventListener("error",p,!1),m.addEventListener("checking",p,!1),m.addEventListener("noupdate",p,!1),m.addEventListener("downloading",p,!1),m.addEventListener("progress",p,!1),m.addEventListener("updateready",p,!1),m.addEventListener("cached",p,!1)}e.credits=!1,e.toggleCredits=function(){e.credits=e.credits===!1?!0:!1,e.credits===!0&&c.scrollToElement(u.find("#credits-block"),0,1500,function(e){return.5>e?2*e*e:-1+(4-2*e)*e})},d.currentSound&&d.currentSound.stop(),"yes"==l.get("finished")?(l.set("finished","no"),a.info("[start] finished",l.get("finished")),e.toggleCredits()):a.info("[start] go!")}]),app.controller("PlacesCtrl",["$rootScope","$scope","$sce","$routeParams","Places","$log","$window","$element","$location","$timeout","Geolocation","$document",function(e,n,i,a,o,t,r,s,d){n.nextSlideId=o.indexToSlideId(n.currentSlide+1),n.nextSlide=o.slides[n.currentSlide+1],n.prevSlideId=o.indexToSlideId(n.currentSlide-1);var l=o.slides[n.currentSlide];if(l.audio){angular.forEach(e.audios,function(e){e.pause()});var c=e.audios[l.id];c.bind("ended",function(){l.maps?t.info("dont go to next slide because the current slide is a map"):(d.path(n.nextSlide.id).replace(),e.$apply())}),c.play()}n.$on("map:destination:reached",function(){d.path(n.nextSlide.id).replace()})}]),app.controller("MapCtrl",["$log","$element","$scope","$location","$rootScope","$q","Geolocation",function(e,n,i,a,o,t,r){function s(n){return e.info("current position",n),i.map.currentPosition={longitude:n.coords.longitude,latitude:n.coords.latitude},i.map.origin=""+n.coords.latitude+","+n.coords.longitude,i.getDirections().then(i.getDistance)}i.map={center:{latitude:52.5075419,longitude:13.4261419},control:{},zoom:16,options:{fit:!0,streetViewControl:!1,maxZoom:40,minZoom:10,mapTypeId:"roadmap"},currentPosition:{},markers:[],currentMarkerOptions:{animation:google.maps.Animation.BOUNCE},distanceToDestination:{distance:null,duration:null}},i.watchUserPosition=function(){e.info("[map] watching movements"),o.$on("geolocation:changed",function(n,i){s(i).catch(function(n){e.error("cannot get directions",n)})}),o.$on("geolocation:error",function(n,i){e.error("Failed watching position",i)}),r.watch()},r.current().then(function(n){s(n).then(function(){i.watchUserPosition()}).catch(function(n){e.error("cannot get directions",n)})}).catch(function(n){e.error("Failed to read current Position",n)});var d=new google.maps.DirectionsRenderer,l=new google.maps.DirectionsService,c=new google.maps.DistanceMatrixService,u=new google.maps.Geocoder;i.init=function(){i.endPoint=void 0!==i.slide.maps.destination?i.slide.maps.destination:"Linienstraße 206, Berlin, Germany",u.geocode({address:i.endPoint},function(e,n){var a=e[0].geometry.location;n===google.maps.GeocoderStatus.OK?i.map.control.getGMap().setCenter(a):alert("Cannot Geocode")})},i.init(),i.getDirections=function(){var e=t.defer(),n={origin:i.map.origin,destination:i.slide.maps.destination,waypoints:i.slide.maps.waypoints,travelMode:google.maps.DirectionsTravelMode.WALKING};return l.route(n,function(n,a){a===google.maps.DirectionsStatus.OK?(d.setDirections(n),d.setMap(i.map.control.getGMap()),e.resolve(n)):e.reject(a,n)}),e.promise},i.getDistance=function(){var n=t.defer();return c.getDistanceMatrix({origins:[i.map.origin],destinations:[i.slide.maps.destination],travelMode:google.maps.TravelMode.WALKING,durationInTraffic:!1,avoidHighways:!1,avoidTolls:!1},function(a,o){e.info("[map] distances",a,o);var t=a.rows[0].elements[0];"ZERO_RESULTS"===t.status?n.reject("cannot calculate distance"):(t.distance.value<=15&&(r.unwatch(),i.$emit("map:destination:reached")),i.map.distanceToDestination.distance=t.distance.text,i.map.distanceToDestination.duration=t.duration.text,n.resolve(t))}),n.promise}}]),app.service("Geolocation",["$rootScope","$window","$q","$log",function(e,n,i,a){var o=this,t=null;this.supportGeolocation=!!n.navigator,this.current=function(){var a=i.defer();return o.supportGeolocation?n.navigator.geolocation.getCurrentPosition(function(n){e.$apply(function(){a.resolve(n)},function(e){a.reject(e)})}):a.reject({message:"Device does not support Geolocation"}),a.promise},this.watch=function(){o.supportGeolocation?t=n.navigator.geolocation.watchPosition(function(n){e.$emit("geolocation:changed",n)},function(n){e.$emit("geolocation:error",n)}):e.$emit("geolocation:error","device does not support geolocation")},this.unwatch=function(){t&&(a.info("[geo] unwatching"),n.navigator.geolocation.clearWatch(t))}}]),app.value("StoryBoard",function(){return[{id:"weg-zum-st-oberholz",caption:"Weg zum St. Oberholz",maps:{destination:"Rosenthaler Straße 72a, Berlin, Germany"}},{id:"st-oberholz",caption:"St. Oberholz",audio:"/audio/st.oberholz.mp3",image:"/images/StOberholz.jpg"},{id:"ausland",caption:"Weg zum Haus aus einem anderen Land",maps:{destination:"52.529781,13.401393",waypoints:[{location:"Rosenthaler Straße 72a, Berlin, Germany"}]},audio:"/audio/02-jura.mp3",autoplay:!0},{id:"haus-aus-einem-anderen-land",caption:"Haus aus einem anderen Land",audio:"/audio/haus_aus_einem_anderen_land.mp3",image:"/images/Haus_aus_einem_anderen_Land.jpg"},{id:"weg-zum-leihamt",caption:"Weg zum Königlichen Leihamt",maps:{destination:"Linienstraße 98, Berlin, Germany",waypoints:[{location:"Brunnenstraße 10, Berlin, Germany"}],kml:"/data/leihamt.kml",zoom:16},audio:"/audio/3_bnw_unterwegs_sounds_1_120614.mp3",autoplay:!0},{id:"leihamt",caption:"Königliches Leihamt",audio:"/audio/leihamt.mp3",image:"/images/Leihamt.jpg"},{id:"weg-zum-leerstehenden-haus",caption:"Weg zum Leerstehenden Haus",maps:{destination:"Linienstraße 86, Berlin, Germany",waypoints:[{location:"Linienstraße 98, Berlin, Germany"}]},audio:"/audio/5_bnw_zwischen_ort_4_u_5_fuge_klavier_130614.mp3",autoplay:!0},{id:"leerstehendes-haus",caption:"Leerstehendes Haus",audio:"/audio/leerstehendes_haus.mp3",image:"/images/Leerstehendes_Haus.jpg"},{id:"weg-zum-besetzten-haus",caption:"Weg zum besetzten Haus",maps:{destination:"Linienstraße 206, Berlin, Germany",waypoints:[{location:"Linienstraße 86, Berlin, Germany"}]}},{id:"linienstrasse-206",caption:"Linienstrasse 206",audio:"audio/besetztes_haus.mp3",image:"/images/Besetztes_Haus.jpg"},{id:"weg-zum-garnisonsfriedhof",caption:"Weg zum Garnisonsfriedhof",maps:{destination:"Garnisonsfriedhof, Kleine Rosenthaler Straße, Berlin, Germany",waypoints:[{location:"Linienstraße 206, Berlin, Germany"}]}},{id:"garnisonsfriedhof",caption:"Garnisonsfriedhof",audio:"/audio/garnisonsfriedhof.mp3",image:"/images/Garnisonsfriedhof.jpg"},{id:"weg-zum-centralen-arbeitsnachweis",caption:"Weg zum Centralen Arbeitsnachweis",maps:{destination:"Gormannstraße 13, Berlin, Germany",waypoints:[{location:"Garnisonsfriedhof, Kleine Rosenthaler Straße, Berlin, Germany"}]}},{id:"centraler-arbeitsnachweis",caption:"Centraler Arbeitsnachweis",audio:"/audio/arbeitsnachweis.mp3",image:"/images/Arbeitsnachweis.jpg"},{id:"weg-zum-wunschgarten",caption:"Weg zum Wunschgarten",maps:{destination:"Mulackstraße 8-11, Berlin, Germany",waypoints:[{location:"Gormannstraße 13, Berlin, Germany"}]}},{id:"wunschgarten",caption:"Wunschgarten",audio:"/audio/wunschgarten_flitterzaun.mp3",image:"/images/Wunschgarten.jpg"},{id:"weg-zum-flitterzaun",caption:"Weg zum Flitterzaun",maps:{destination:"Mulackstraße 38-41, Berlin, Germany",waypoints:[{location:"Mulackstraße 8-11, Berlin, Germany"}]}},{id:"flitterzaun",caption:"Flitterzaun",audio:"/audio/wunschgarten_flitterzaun.mp3",image:"/images/Flitterzaun.jpg"},{id:"weg-zur-volksbuehne",caption:"Weg zur Volksbühne",maps:{destination:"52.527049,13.411903",waypoints:[{location:"Mulackstraße 38-41, Berlin, Germany"}]}},{id:"volksbuehne",caption:"Volksbühne AM Rosa-Luxemburg-Platz",audio:"/audio/volksbuehne.mp3",image:"/images/Volksbuehne.jpg"},{id:"weg-zum-arbeiterdenkmal",caption:"Weg zum Arbeiterdenkmal",maps:{destination:"52.525248,13.413445",waypoints:[{location:"52.527049,13.411903"}]}},{id:"arbeiterdenkmal",caption:"Arbeiterdenkmal",audio:"/audio/arbeiterdenkmal.mp3",image:"/images/Arbeiterdenkmal.jpg"},{id:"weg-zum-karl-liebknecht-haus",caption:"Weg zum Karl-Liebknecht-Haus",maps:{destination:"Kleine Alexanderstraße 28, Berlin, Germany",waypoints:[{location:"52.525248,13.413445"}]}},{id:"karl-liebknecht-haus",caption:"Karl-Liebknecht-Haus",audio:"/audio/karl-liebknecht-haus.mp3",image:"/images/Karl-Liebknecht-Haus.jpg"},{id:"weg-zum-soho-haus",caption:"Weg zum Soho-House",maps:{destination:"Torstraße 1, Berlin, Germany",waypoints:[{location:"Kleine Alexanderstraße 28, Berlin, Germany"}]}},{id:"soho-House",caption:"Soho-House",audio:"/audio/soho-house.mp3",image:"/images/Soho.jpg"}]}),app.factory("Places",["StoryBoard","$log",function(e){var n=e();return{idToSlideIndex:function(e){var i=n.filter(function(n){return n.id==e});return i[0]?n.indexOf(i[0]):0},indexToSlideId:function(e){var i;return(i=n[e])?i.id:null},slides:n}}]),app.directive("bnwModal",["$log",function(){return{restrict:"E",scope:{show:"="},replace:!0,transclude:!0,link:function(e){e.accept=function(){e.$emit("modal:accepted")}},templateUrl:"views/partials/modal.html"}}]);